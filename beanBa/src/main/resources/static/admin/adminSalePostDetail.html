<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>📝 상품 상세 정보 (관리자)</title>
    <style>
        .image-slot-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .image-slot {
            width: 120px;
            height: 120px;
            border: 1px dashed gray;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .image-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .upload-label {
            font-size: 30px;
            cursor: pointer;
            color: #aaa;
        }
        .image-input {
            display: none;
        }
        .delete-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        label {
            display: block;
            margin: 8px 0 4px;
        }
    </style>
</head>
<body>
<h1>📝 상품 상세 정보 (관리자)</h1>
<div id="detail"></div>

<!-- 버튼 영역 -->
<div style="margin-top:20px;">
    <button onclick="enableEditMode()">✏️ 수정하기</button>
    <button onclick="goBack()">🔙 목록으로</button>
    <button onclick="confirmDelete()" style="background:#d9534f;color:#fff;">🗑️ 삭제</button>
</div>

<!-- 수정 폼 영역 -->
<form id="editForm" style="display:none;margin-top:20px;">
    <!-- 제목, 내용, 가격 -->
    <label>제목: <input type="text" id="editTitle"/></label><br/>
    <label>내용:<br/><textarea id="editContent" rows="4"></textarea></label><br/>
    <label>희망 가격: <input type="number" id="editHopePrice"/></label><br/>

    <!-- 위도, 경도 -->
    <label>위도: <input type="number" step="0.0000001" id="editLatitude"/></label><br/>
    <label>경도: <input type="number" step="0.0000001" id="editLongitude"/></label><br/>

    <!-- 카테고리 셀렉트 박스 -->
    <label>카테고리:
        <select id="editCategoryPk"></select>
        <span id="categoryNameText">현재 카테고리: </span>
    </label><br/>

    <label>삭제여부:
        <select id="editDeleteYn">
            <option value="N">N</option>
            <option value="Y">Y</option>
        </select>
        <span id="deleteYnText">현재 삭제여부: </span>
    </label><br/>

    <!-- 이미지 슬롯 -->
    <label>이미지:</label><div id="imageSlots" class="image-slot-container"></div>
    <button type="submit">💾 저장</button>
</form>

<script>
    let postData, currentPostPk;
    let currentImageUrls = ["", "", "", ""], newImages = [null, null, null, null], draggedIndex;

    async function loadPostDetail() {
        const pk = new URLSearchParams(window.location.search).get("postPk");
        currentPostPk = pk;
        const res = await fetch(`/api/admin/sale-post/${pk}`);
        if (!res.ok) return alert("불러오기 실패");
        postData = await res.json();

        console.log(postData);


        // 상품 상세 정보 출력
        document.getElementById("detail").innerHTML = `
        <div><strong>제목:</strong> ${postData.title}</div>
        <div><strong>카테고리:</strong> ${postData.categoryName} (PK: ${postData.categoryPk})</div>
        <div><strong>가격:</strong> ${postData.hopePrice}원</div>
        <div><strong>삭제여부:</strong> ${postData.deleteYn}</div>
        <div><strong>위도:</strong> ${postData.latitude}</div>
        <div><strong>경도:</strong> ${postData.longitude}</div>
        <div><strong>내용:</strong><br/>${postData.content}</div>
        <div><strong>이미지:</strong><br/>${postData.imageUrls.map(u => `<img src="${u}" style="max-width:100px;margin:2px;">`).join('')}
        </div>`;

        currentImageUrls = postData.imageUrls.slice(0, 4);
        newImages = [null, null, null, null];

        // 수정 전 값 텍스트로 표시
        document.getElementById("categoryNameText").textContent = `현재 카테고리: ${postData.categoryName}`;
        document.getElementById("deleteYnText").textContent = `현재 삭제여부: ${postData.deleteYn === 'Y' ? '삭제됨' : '삭제안됨'}`;

    }

    async function enableEditMode() {
        if (!postData) return alert("데이터 없음");

        document.getElementById("editForm").style.display = "block";
        document.getElementById("editTitle").value = postData.title;
        document.getElementById("editContent").value = postData.content;
        document.getElementById("editHopePrice").value = postData.hopePrice;
        document.getElementById("editLatitude").value = postData.latitude || ''; // 위도 값
        document.getElementById("editLongitude").value = postData.longitude || ''; // 경도 값

        // 카테고리와 삭제여부 기본값을 기존값으로 설정
        await loadCategories();
        document.getElementById("editCategoryPk").value = postData.categoryPk;  // 기존 카테고리 설정
        document.getElementById("editDeleteYn").value = postData.deleteYn;       // 기존 삭제여부 설정

        // 수정 전 값이 잘 반영되도록
        await loadCategories();
        renderImageSlots();
    }

    async function loadCategories() {
        const res = await fetch('/api/admin/sale-post/categories'); // 전체 카테고리 조회
        if (!res.ok) return alert("카테고리 불러오기 실패");
        const cats = await res.json();
        const sel = document.getElementById("editCategoryPk");
        sel.innerHTML = ""; // 기존 option 초기화
        cats.forEach(c => {
            const o = document.createElement("option");
            o.value = c.categoryPk;
            o.text = `${c.categoryName}`;
            sel.append(o);
        });

        // 기존 카테고리 값 설정
        setTimeout(() => setCategoryValue(postData.categoryPk), 100);  // 100ms 대기 후 값 설정
    }
    function setCategoryValue(categoryPk) {
        const sel = document.getElementById("editCategoryPk");
        const option = sel.querySelector(`option[value="${categoryPk}"]`);
        if (option) option.selected = true;  // 해당 카테고리 선택
    }

    function setDeleteYnValue(deleteYn) {
        const sel = document.getElementById("editDeleteYn");
        const option = sel.querySelector(`option[value="${deleteYn}"]`);
        if (option) option.selected = true;  // 해당 삭제여부 선택
    }

    function renderImageSlots() {
        const container = document.getElementById("imageSlots");
        container.innerHTML = "";

        for (let i = 0; i < 4; i++) {
            const slot = document.createElement("div");
            slot.className = "image-slot";
            slot.draggable = true;
            slot.dataset.index = i;

            slot.ondragstart = () => (draggedIndex = i);
            slot.ondragover = (e) => e.preventDefault();
            slot.ondrop = (e) => {
                e.preventDefault();
                const targetIndex = parseInt(e.currentTarget.dataset.index);
                [currentImageUrls[draggedIndex], currentImageUrls[targetIndex]] = [currentImageUrls[targetIndex], currentImageUrls[draggedIndex]];
                [newImages[draggedIndex], newImages[targetIndex]] = [newImages[targetIndex], newImages[draggedIndex]];
                renderImageSlots();
            };

            if (currentImageUrls[i]) {
                const img = document.createElement("img");
                img.src = currentImageUrls[i];
                slot.appendChild(img);
            } else if (newImages[i]) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(newImages[i]);
                slot.appendChild(img);
            } else {
                const label = document.createElement("label");
                label.className = "upload-label";
                label.innerText = "+";
                label.htmlFor = `upload${i}`;

                const input = document.createElement("input");
                input.type = "file";
                input.accept = "image/*";
                input.id = `upload${i}`;
                input.className = "image-input";
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        currentImageUrls[i] = "";
                        newImages[i] = file;
                        renderImageSlots();
                    }
                };

                slot.appendChild(label);
                slot.appendChild(input);
            }

            if (currentImageUrls[i] || newImages[i]) {
                const btn = document.createElement("button");
                btn.innerText = "X";
                btn.className = "delete-btn";
                btn.type = "button";
                btn.onclick = () => {
                    currentImageUrls[i] = "";
                    newImages[i] = null;
                    renderImageSlots();
                };
                slot.appendChild(btn);
            }

            container.appendChild(slot);
        }
    }

    document.getElementById("editForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const req = {
            title: document.getElementById("editTitle").value,
            content: document.getElementById("editContent").value,
            hopePrice: parseInt(document.getElementById("editHopePrice").value),
            latitude: parseFloat(document.getElementById("editLatitude").value),
            longitude: parseFloat(document.getElementById("editLongitude").value),
            categoryPk: parseInt(document.getElementById("editCategoryPk").value),
            deleteYn: document.getElementById("editDeleteYn").value,
            imageUrls: currentImageUrls
        };

        const fd = new FormData();
        fd.append("salePostRequest", new Blob([JSON.stringify(req)], { type: "application/json" }));
        newImages.filter(f => f).forEach(f => fd.append("salePostImages", f));

        const res = await fetch(`/api/admin/sale-post/${currentPostPk}`, { method: "PUT", body: fd });
        alert(res.ok ? "✅ 수정 성공" : "❌ 수정 실패");
        if (res.ok) window.location.reload();
    });

    function confirmDelete() {
        if (!confirm("정말 삭제?")) return;
        fetch(`/api/admin/sale-post/${currentPostPk}`, { method: "DELETE" })
            .then(res => alert(res.ok ? "✅ 삭제됨" : "❌ 실패") && goBack())
            .catch(() => alert("❌ 오류"));
    }

    function goBack() { location.href = "/admin/adminSalePost.html"; }
    window.onload = loadPostDetail;
</script>
</body>
</html>
