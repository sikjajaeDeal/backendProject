<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“ ìƒí’ˆ ìƒì„¸ ì •ë³´ (ê´€ë¦¬ì)</title>
    <style>
        .image-slot-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .image-slot {
            width: 120px;
            height: 120px;
            border: 1px dashed gray;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .image-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .upload-label {
            font-size: 30px;
            cursor: pointer;
            color: #aaa;
        }
        .image-input {
            display: none;
        }
        .delete-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        label {
            display: block;
            margin: 8px 0 4px;
        }
    </style>
</head>
<body>
<h1>ğŸ“ ìƒí’ˆ ìƒì„¸ ì •ë³´ (ê´€ë¦¬ì)</h1>
<div id="detail"></div>

<!-- ë²„íŠ¼ ì˜ì—­ -->
<div style="margin-top:20px;">
    <button onclick="enableEditMode()">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
    <button onclick="goBack()">ğŸ”™ ëª©ë¡ìœ¼ë¡œ</button>
    <button onclick="confirmDelete()" style="background:#d9534f;color:#fff;">ğŸ—‘ï¸ ì‚­ì œ</button>
</div>

<!-- ìˆ˜ì • í¼ ì˜ì—­ -->
<form id="editForm" style="display:none;margin-top:20px;">
    <!-- ì œëª©, ë‚´ìš©, ê°€ê²© -->
    <label>ì œëª©: <input type="text" id="editTitle"/></label><br/>
    <label>ë‚´ìš©:<br/><textarea id="editContent" rows="4"></textarea></label><br/>
    <label>í¬ë§ ê°€ê²©: <input type="number" id="editHopePrice"/></label><br/>

    <!-- ìœ„ë„, ê²½ë„ -->
    <label>ìœ„ë„: <input type="number" step="0.0000001" id="editLatitude"/></label><br/>
    <label>ê²½ë„: <input type="number" step="0.0000001" id="editLongitude"/></label><br/>

    <!-- ì¹´í…Œê³ ë¦¬ ì…€ë ‰íŠ¸ ë°•ìŠ¤ -->
    <label>ì¹´í…Œê³ ë¦¬:
        <select id="editCategoryPk"></select>
        <span id="categoryNameText">í˜„ì¬ ì¹´í…Œê³ ë¦¬: </span>
    </label><br/>

    <label>ì‚­ì œì—¬ë¶€:
        <select id="editDeleteYn">
            <option value="N">N</option>
            <option value="Y">Y</option>
        </select>
        <span id="deleteYnText">í˜„ì¬ ì‚­ì œì—¬ë¶€: </span>
    </label><br/>

    <!-- ì´ë¯¸ì§€ ìŠ¬ë¡¯ -->
    <label>ì´ë¯¸ì§€:</label><div id="imageSlots" class="image-slot-container"></div>
    <button type="submit">ğŸ’¾ ì €ì¥</button>
</form>

<script>
    let postData, currentPostPk;
    let currentImageUrls = ["", "", "", ""], newImages = [null, null, null, null], draggedIndex;

    async function loadPostDetail() {
        const pk = new URLSearchParams(window.location.search).get("postPk");
        currentPostPk = pk;
        const res = await fetch(`/api/admin/sale-post/${pk}`);
        if (!res.ok) return alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        postData = await res.json();

        console.log(postData);


        // ìƒí’ˆ ìƒì„¸ ì •ë³´ ì¶œë ¥
        document.getElementById("detail").innerHTML = `
        <div><strong>ì œëª©:</strong> ${postData.title}</div>
        <div><strong>ì¹´í…Œê³ ë¦¬:</strong> ${postData.categoryName} (PK: ${postData.categoryPk})</div>
        <div><strong>ê°€ê²©:</strong> ${postData.hopePrice}ì›</div>
        <div><strong>ì‚­ì œì—¬ë¶€:</strong> ${postData.deleteYn}</div>
        <div><strong>ìœ„ë„:</strong> ${postData.latitude}</div>
        <div><strong>ê²½ë„:</strong> ${postData.longitude}</div>
        <div><strong>ë‚´ìš©:</strong><br/>${postData.content}</div>
        <div><strong>ì´ë¯¸ì§€:</strong><br/>${postData.imageUrls.map(u => `<img src="${u}" style="max-width:100px;margin:2px;">`).join('')}
        </div>`;

        currentImageUrls = postData.imageUrls.slice(0, 4);
        newImages = [null, null, null, null];

        // ìˆ˜ì • ì „ ê°’ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
        document.getElementById("categoryNameText").textContent = `í˜„ì¬ ì¹´í…Œê³ ë¦¬: ${postData.categoryName}`;
        document.getElementById("deleteYnText").textContent = `í˜„ì¬ ì‚­ì œì—¬ë¶€: ${postData.deleteYn === 'Y' ? 'ì‚­ì œë¨' : 'ì‚­ì œì•ˆë¨'}`;

    }

    async function enableEditMode() {
        if (!postData) return alert("ë°ì´í„° ì—†ìŒ");

        document.getElementById("editForm").style.display = "block";
        document.getElementById("editTitle").value = postData.title;
        document.getElementById("editContent").value = postData.content;
        document.getElementById("editHopePrice").value = postData.hopePrice;
        document.getElementById("editLatitude").value = postData.latitude || ''; // ìœ„ë„ ê°’
        document.getElementById("editLongitude").value = postData.longitude || ''; // ê²½ë„ ê°’

        // ì¹´í…Œê³ ë¦¬ì™€ ì‚­ì œì—¬ë¶€ ê¸°ë³¸ê°’ì„ ê¸°ì¡´ê°’ìœ¼ë¡œ ì„¤ì •
        await loadCategories();
        document.getElementById("editCategoryPk").value = postData.categoryPk;  // ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ì„¤ì •
        document.getElementById("editDeleteYn").value = postData.deleteYn;       // ê¸°ì¡´ ì‚­ì œì—¬ë¶€ ì„¤ì •

        // ìˆ˜ì • ì „ ê°’ì´ ì˜ ë°˜ì˜ë˜ë„ë¡
        await loadCategories();
        renderImageSlots();
    }

    async function loadCategories() {
        const res = await fetch('/api/admin/sale-post/categories'); // ì „ì²´ ì¹´í…Œê³ ë¦¬ ì¡°íšŒ
        if (!res.ok) return alert("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        const cats = await res.json();
        const sel = document.getElementById("editCategoryPk");
        sel.innerHTML = ""; // ê¸°ì¡´ option ì´ˆê¸°í™”
        cats.forEach(c => {
            const o = document.createElement("option");
            o.value = c.categoryPk;
            o.text = `${c.categoryName}`;
            sel.append(o);
        });

        // ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ê°’ ì„¤ì •
        setTimeout(() => setCategoryValue(postData.categoryPk), 100);  // 100ms ëŒ€ê¸° í›„ ê°’ ì„¤ì •
    }
    function setCategoryValue(categoryPk) {
        const sel = document.getElementById("editCategoryPk");
        const option = sel.querySelector(`option[value="${categoryPk}"]`);
        if (option) option.selected = true;  // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì„ íƒ
    }

    function setDeleteYnValue(deleteYn) {
        const sel = document.getElementById("editDeleteYn");
        const option = sel.querySelector(`option[value="${deleteYn}"]`);
        if (option) option.selected = true;  // í•´ë‹¹ ì‚­ì œì—¬ë¶€ ì„ íƒ
    }

    function renderImageSlots() {
        const container = document.getElementById("imageSlots");
        container.innerHTML = "";

        for (let i = 0; i < 4; i++) {
            const slot = document.createElement("div");
            slot.className = "image-slot";
            slot.draggable = true;
            slot.dataset.index = i;

            slot.ondragstart = () => (draggedIndex = i);
            slot.ondragover = (e) => e.preventDefault();
            slot.ondrop = (e) => {
                e.preventDefault();
                const targetIndex = parseInt(e.currentTarget.dataset.index);
                [currentImageUrls[draggedIndex], currentImageUrls[targetIndex]] = [currentImageUrls[targetIndex], currentImageUrls[draggedIndex]];
                [newImages[draggedIndex], newImages[targetIndex]] = [newImages[targetIndex], newImages[draggedIndex]];
                renderImageSlots();
            };

            if (currentImageUrls[i]) {
                const img = document.createElement("img");
                img.src = currentImageUrls[i];
                slot.appendChild(img);
            } else if (newImages[i]) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(newImages[i]);
                slot.appendChild(img);
            } else {
                const label = document.createElement("label");
                label.className = "upload-label";
                label.innerText = "+";
                label.htmlFor = `upload${i}`;

                const input = document.createElement("input");
                input.type = "file";
                input.accept = "image/*";
                input.id = `upload${i}`;
                input.className = "image-input";
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        currentImageUrls[i] = "";
                        newImages[i] = file;
                        renderImageSlots();
                    }
                };

                slot.appendChild(label);
                slot.appendChild(input);
            }

            if (currentImageUrls[i] || newImages[i]) {
                const btn = document.createElement("button");
                btn.innerText = "X";
                btn.className = "delete-btn";
                btn.type = "button";
                btn.onclick = () => {
                    currentImageUrls[i] = "";
                    newImages[i] = null;
                    renderImageSlots();
                };
                slot.appendChild(btn);
            }

            container.appendChild(slot);
        }
    }

    document.getElementById("editForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const req = {
            title: document.getElementById("editTitle").value,
            content: document.getElementById("editContent").value,
            hopePrice: parseInt(document.getElementById("editHopePrice").value),
            latitude: parseFloat(document.getElementById("editLatitude").value),
            longitude: parseFloat(document.getElementById("editLongitude").value),
            categoryPk: parseInt(document.getElementById("editCategoryPk").value),
            deleteYn: document.getElementById("editDeleteYn").value,
            imageUrls: currentImageUrls
        };

        const fd = new FormData();
        fd.append("salePostRequest", new Blob([JSON.stringify(req)], { type: "application/json" }));
        newImages.filter(f => f).forEach(f => fd.append("salePostImages", f));

        const res = await fetch(`/api/admin/sale-post/${currentPostPk}`, { method: "PUT", body: fd });
        alert(res.ok ? "âœ… ìˆ˜ì • ì„±ê³µ" : "âŒ ìˆ˜ì • ì‹¤íŒ¨");
        if (res.ok) window.location.reload();
    });

    function confirmDelete() {
        if (!confirm("ì •ë§ ì‚­ì œ?")) return;
        fetch(`/api/admin/sale-post/${currentPostPk}`, { method: "DELETE" })
            .then(res => alert(res.ok ? "âœ… ì‚­ì œë¨" : "âŒ ì‹¤íŒ¨") && goBack())
            .catch(() => alert("âŒ ì˜¤ë¥˜"));
    }

    function goBack() { location.href = "/admin/adminSalePost.html"; }
    window.onload = loadPostDetail;
</script>
</body>
</html>
